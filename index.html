<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Evaluation Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Hide scrollbar for clean look in lists */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-graduation-cap text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">EduEval Platform</h1>
            </div>
            <div id="userInfo" class="hidden flex items-center gap-4">
                <span id="welcomeText" class="font-medium"></span>
                <button onclick="logout()" class="bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded text-sm transition">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app" class="flex-1 overflow-y-auto p-4 relative">
        
        <!-- LOGIN / LANDING SCREEN -->
        <div id="view-login" class="max-w-md mx-auto mt-10 bg-white p-8 rounded-lg shadow-md fade-in">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Welcome Back</h2>
            <div class="space-y-4">
                <input type="text" id="loginName" placeholder="Name" class="w-full p-3 border rounded focus:outline-none focus:border-indigo-500">
                <input type="password" id="loginPass" placeholder="Password" class="w-full p-3 border rounded focus:outline-none focus:border-indigo-500">
                <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 font-bold transition">Login</button>
            </div>
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>New here?</p>
                <div class="flex justify-center gap-4 mt-2">
                    <button onclick="showView('view-signup-teacher')" class="text-indigo-600 hover:underline">Signup as Teacher</button>
                    <span>|</span>
                    <button onclick="showView('view-signup-student')" class="text-indigo-600 hover:underline">Signup as Student</button>
                </div>
            </div>
        </div>

        <!-- SIGNUP TEACHER -->
        <div id="view-signup-teacher" class="hidden max-w-lg mx-auto mt-6 bg-white p-8 rounded-lg shadow-md fade-in">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">Teacher Registration</h2>
            <div class="space-y-3">
                <input id="tName" type="text" placeholder="Name" class="w-full p-2 border rounded">
                <input id="tPass" type="password" placeholder="Password" class="w-full p-2 border rounded">
                <input id="tSubj" type="text" placeholder="Subject" class="w-full p-2 border rounded">
                <input id="tCode" type="text" placeholder="Course Code (e.g. CSE101)" class="w-full p-2 border rounded">
                <input id="tContact" type="text" placeholder="Contact Number" class="w-full p-2 border rounded">
                <input id="tAvail" type="text" placeholder="Availability" class="w-full p-2 border rounded">
                <div class="flex gap-2 pt-4">
                    <button onclick="showView('view-login')" class="flex-1 bg-gray-200 py-2 rounded">Cancel</button>
                    <button onclick="signupTeacher()" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Register</button>
                </div>
            </div>
        </div>

        <!-- SIGNUP STUDENT -->
        <div id="view-signup-student" class="hidden max-w-lg mx-auto mt-6 bg-white p-8 rounded-lg shadow-md fade-in">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">Student Registration</h2>
            <div class="space-y-3 h-96 overflow-y-auto pr-2">
                <input id="sName" type="text" placeholder="Name" class="w-full p-2 border rounded">
                <input id="sPass" type="password" placeholder="Password" class="w-full p-2 border rounded">
                <input id="sId" type="text" placeholder="University ID (e.g. 242-15-479)" class="w-full p-2 border rounded">
                <input id="sNo" type="text" placeholder="Contact No" class="w-full p-2 border rounded">
                <input id="sBatch" type="text" placeholder="Batch No" class="w-full p-2 border rounded">
                <div class="bg-gray-50 p-3 rounded text-sm">
                    <p class="mb-2 font-semibold">Previous CGPAs (comma separated)</p>
                    <input id="sCgpa" type="text" placeholder="e.g. 3.5, 3.8, 4.0" class="w-full p-2 border rounded">
                </div>
                <input id="sSkills" type="text" placeholder="Skills (comma separated)" class="w-full p-2 border rounded">
                <input id="sLinks" type="text" placeholder="Links (comma separated)" class="w-full p-2 border rounded">
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="showView('view-login')" class="flex-1 bg-gray-200 py-2 rounded">Cancel</button>
                <button onclick="signupStudent()" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Register</button>
            </div>
        </div>

        <!-- TEACHER DASHBOARD -->
        <div id="view-teacher-dash" class="hidden container mx-auto fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow h-fit">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-indigo-600 text-2xl font-bold mb-2">
                            <span id="teacherInitialsDisplay">T</span>
                        </div>
                        <h3 id="teacherNameDisplay" class="font-bold text-lg">Teacher Name</h3>
                        <p id="teacherCodeDisplay" class="text-sm text-gray-500">Code</p>
                    </div>
                    <nav class="space-y-2">
                        <button onclick="switchTab('t-profile')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab active-tab" data-tab="t-profile"><i class="fas fa-user mr-2"></i> Profile</button>
                        <button onclick="switchTab('t-search')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab" data-tab="t-search"><i class="fas fa-search mr-2"></i> Search Student</button>
                        <button onclick="switchTab('t-eval')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab" data-tab="t-eval"><i class="fas fa-star mr-2"></i> Evaluate Student</button>
                        <button onclick="switchTab('t-problems')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab" data-tab="t-problems"><i class="fas fa-question-circle mr-2"></i> Problems</button>
                        <button onclick="switchTab('t-leaderboard')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab" data-tab="t-leaderboard"><i class="fas fa-trophy mr-2"></i> Leaderboards</button>
                        <button onclick="switchTab('t-extracare')" class="w-full text-left p-2 hover:bg-indigo-50 rounded t-tab" data-tab="t-extracare"><i class="fas fa-heart mr-2"></i> Extra Care List</button>
                    </nav>
                </div>

                <!-- Content -->
                <div class="md:col-span-3">
                    <!-- Profile Tab -->
                    <div id="t-profile" class="tab-content bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-xl font-bold">My Profile</h2>
                            <button onclick="enableEditMode('teacher')" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded"><i class="fas fa-edit"></i> Edit</button>
                        </div>
                        
                        <!-- View Mode -->
                        <div id="teacherProfileView" class="space-y-2 text-gray-700"></div>

                        <!-- Edit Mode -->
                        <div id="teacherProfileEdit" class="hidden space-y-4">
                            <div class="p-4 bg-yellow-50 rounded text-sm text-yellow-700 mb-2">
                                Note: Name and Course Code cannot be changed.
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Subject</label>
                                <input id="editTSubject" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Contact Number</label>
                                <input id="editTContact" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Availability</label>
                                <input id="editTAvail" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div class="pt-4 border-t">
                                <h3 class="font-bold mb-2">Change Password</h3>
                                <input id="editTPass" type="password" placeholder="New Password (leave blank to keep current)" class="w-full p-2 border rounded">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveProfile('teacher')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Save Changes</button>
                                <button onclick="cancelEdit('teacher')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Student Tab -->
                    <div id="t-search" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Search Student</h2>
                        <div class="flex gap-2 mb-6">
                            <input id="searchStudentId" type="text" placeholder="Enter Student University ID" class="p-2 border rounded flex-1">
                            <button onclick="searchStudent()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"><i class="fas fa-search"></i> Search</button>
                        </div>
                        <div id="student searchResult"></div>
                    </div>

                    <!-- Evaluation Tab -->
                    <div id="t-eval" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Evaluate Student</h2>
                        <div class="space-y-4 max-w-lg">
                            <div>
                                <label class="block text-sm font-medium">Student University ID</label>
                                <input id="evalId" type="text" class="w-full p-2 border rounded mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Course</label>
                                <input id="evalCourse" type="text" class="w-full p-2 border rounded mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Stars (1-5)</label>
                                <select id="evalStars" class="w-full p-2 border rounded mt-1">
                                    <option value="5">5 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="2">2 Stars</option>
                                    <option value="1">1 Star</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Comment</label>
                                <textarea id="evalComment" class="w-full p-2 border rounded mt-1" rows="3"></textarea>
                            </div>
                            <button onclick="submitEvaluation()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Submit Evaluation</button>
                        </div>
                    </div>

                    <!-- Problems Tab -->
                    <div id="t-problems" class="tab-content hidden space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <h2 class="text-xl font-bold">Problem Feed</h2>
                            <button onclick="renderProblems('teacher')" class="text-sm text-indigo-600"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        <div id="teacherProblemList" class="space-y-4"></div>
                    </div>

                    <!-- Leaderboard Tab -->
                    <div id="t-leaderboard" class="tab-content hidden bg-white p-6 rounded-lg shadow"> 
                        <div class="flex gap-4 mb-4">
                            <button onclick="renderLeaderboard('student')" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded hover:bg-indigo-200">Student Rankings</button>
                            <button onclick="renderLeaderboard('teacher')" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded hover:bg-indigo-200">Teacher Rankings</button>
                        </div>
                        <div id="leaderboardContent" class="overflow-x-auto"></div>
                    </div>

                    <!-- Extra Care Tab -->
                    <div id="t-extracare" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Extra Care Management</h2>
                        <div class="flex gap-2 mb-6">
                            <input id="extraCareId" type="text" placeholder="Student ID to Add" class="p-2 border rounded flex-1">
                            <button onclick="addToExtraCare()" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">Add to List</button>
                        </div>
                        <h3 class="font-bold mb-2 text-gray-600">Current List:</h3>
                        <div id="extraCareList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STUDENT DASHBOARD -->
        <div id="view-student-dash" class="hidden container mx-auto fade-in"> 
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow h-fit">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600 text-2xl font-bold mb-2">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <h3 id="studentNameDisplay" class="font-bold text-lg">Student Name</h3>
                        <p id="studentIdDisplay" class="text-sm text-gray-500">ID</p>
                    </div>
                    <nav class="space-y-2">
                        <button onclick="switchTab('s-profile')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab active-tab" data-tab="s-profile"><i class="fas fa-user mr-2"></i> Profile</button>
                        <button onclick="switchTab('s-search')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab" data-tab="s-search"><i class="fas fa-search mr-2"></i> Search Teacher</button>
                        <button onclick="switchTab('s-search-student')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab" data-tab="s-search-student"><i class="fas fa-user-friends mr-2"></i> Search Student</button>
                        <button onclick="switchTab('s-submit')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab" data-tab="s-submit"><i class="fas fa-pen mr-2"></i> Submit Problem</button>
                        <button onclick="switchTab('s-problems')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab" data-tab="s-problems"><i class="fas fa-list mr-2"></i> View Problems</button>
                        <button onclick="switchTab('s-leaderboard')" class="w-full text-left p-2 hover:bg-green-50 rounded s-tab" data-tab="s-leaderboard"><i class="fas fa-trophy mr-2"></i> Batch Leaderboard</button>
                    </nav>
                </div>

                <!-- Content -->
                <div class="md:col-span-3">
                    <!-- Profile Tab -->
                    <div id="s-profile" class="tab-content bg-white p-6 rounded-lg shadow"> 
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-xl font-bold">My Profile</h2>
                            <button onclick="enableEditMode('student')" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded"><i class="fas fa-edit"></i> Edit</button>
                        </div>
                        
                        <!-- View Mode -->
                        <div id="studentProfileView" class="space-y-2 text-gray-700"></div>

                        <!-- Edit Mode -->
                        <div id="studentProfileEdit" class="hidden space-y-4">
                            <div class="p-4 bg-yellow-50 rounded text-sm text-yellow-700 mb-2">
                                Note: Name, ID, and Batch cannot be changed.
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Contact Number</label>
                                <input id="editSContact" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Skills (comma separated)</label>
                                <input id="editSSkills" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Links (comma separated)</label>
                                <input id="editSLinks" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div class="pt-4 border-t">
                                <h3 class="font-bold mb-2">Change Password</h3>
                                <input id="editSPass" type="password" placeholder="New Password (leave blank to keep current)" class="w-full p-2 border rounded">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveProfile('student')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Save Changes</button>
                                <button onclick="cancelEdit('student')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>

                        <h3 class="font-bold mt-6 mb-2 border-b pb-1">Evaluations</h3>
                        <div id="studentEvaluationsList" class="space-y-3"></div>
                    </div>

                    <!-- Search Teacher Tab -->
                    <div id="s-search" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Search Teacher</h2>
                        <div class="flex gap-2 mb-6">
                            <input id="searchTeacherName" type="text" placeholder="Enter Teacher Name" class="p-2 border rounded flex-1">
                            <button onclick="searchTeacher()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fas fa-search"></i> Search</button>
                        </div>
                        <div id="teacherSearchResult"></div>
                    </div>

                    <!-- Search Student Tab (Student View) -->
                    <div id="s-search-student" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Search Student</h2>
                        <div class="flex gap-2 mb-6">
                            <input id="searchPeerId" type="text" placeholder="Enter Student University ID" class="p-2 border rounded flex-1">
                            <button onclick="searchPeer()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fas fa-search"></i> Search</button>
                        </div>
                        <div id="peerSearchResult"></div>
                    </div>

                    <!-- Submit Problem Tab -->
                    <div id="s-submit" class="tab-content hidden bg-white p-6 rounded-lg shadow"> 
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Submit New Problem</h2>
                        <div class="space-y-4">
                            <input id="probCourse" type="text" placeholder="Course Name" class="w-full p-2 border rounded">
                            <textarea id="probDesc" placeholder="Describe your problem in detail..." class="w-full p-2 border rounded" rows="4"></textarea>
                            <button onclick="submitProblem()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Post Problem</button>
                        </div>
                    </div>

                    <!-- Problems Tab -->
                    <div id="s-problems" class="tab-content hidden space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <h2 class="text-xl font-bold">Global Problems</h2>
                            <button onclick="renderProblems('student')" class="text-sm text-green-600"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        <div id="studentProblemList" class="space-y-4"></div>
                    </div>

                    <!-- Leaderboard Tab -->
                    <div id="s-leaderboard" class="tab-content hidden bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">My Batch Leaderboard</h2>
                        <div id="studentBatchLeaderboard"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 z-50">
        Notification
    </div>

    <script>
        // --- DATA MANAGEMENT ---
        const DB = {
            teachers: JSON.parse(localStorage.getItem('sep_teachers') || '[]'),
            students: JSON.parse(localStorage.getItem('sep_students') || '[]'),
            problems: JSON.parse(localStorage.getItem('sep_problems') || '[]'),
            extraCare: JSON.parse(localStorage.getItem('sep_extracare') || '[]'),
            save: function() {
                localStorage.setItem('sep_teachers', JSON.stringify(this.teachers));
                localStorage.setItem('sep_students', JSON.stringify(this.students));
                localStorage.setItem('sep_problems', JSON.stringify(this.problems));
                localStorage.setItem('sep_extracare', JSON.stringify(this.extraCare));
            }
        };

        let currentUser = null;
        let currentUserType = null; // 'teacher' or 'student'

        // --- NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function switchTab(tabId) {
            const prefix = currentUserType === 'teacher' ? 't' : 's';
            // Update Tab Styling
            document.querySelectorAll(`.${prefix}-tab`).forEach(el => {
                el.classList.remove('bg-indigo-100', 'bg-green-100', 'text-indigo-700', 'text-green-700', 'font-bold');
                el.classList.add('hover:bg-gray-50');
            });
            const activeBtn = document.querySelector(`button[data-tab="${tabId}"]`);
            if(currentUserType === 'teacher') {
                activeBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold');
            } else {
                activeBtn.classList.add('bg-green-100', 'text-green-700', 'font-bold');
            }

            // Show Content
            const parent = currentUserType === 'teacher' ? document.getElementById('view-teacher-dash') : document.getElementById('view-student-dash');
            parent.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            // Trigger specific renders
            if(tabId.includes('problems')) renderProblems(currentUserType);
            if(tabId === 't-extracare') renderExtraCareList();
            if(tabId === 't-leaderboard') renderLeaderboard('student');
            if(tabId === 's-leaderboard') renderBatchLeaderboard();
            if(tabId.includes('profile')) renderProfile();
        }

        // --- AUTH ---
        function signupTeacher() {
            const name = document.getElementById('tName').value;
            const pass = document.getElementById('tPass').value;
            const subj = document.getElementById('tSubj').value;
            const code = document.getElementById('tCode').value;
            const contact = document.getElementById('tContact').value;
            const avail = document.getElementById('tAvail').value;

            if(!name || !pass) return showToast('Name and Password required');

            const initials = name.trim().split(/\s+/).map(p => p[0]).join('').toUpperCase();
            
            DB.teachers.push({ 
                name, password: pass, subject: subj, courseCode: code.toUpperCase(), 
                contactNumber: contact, availability: avail, initials, problemsSolved: 0 
            });
            DB.save();
            showToast('Teacher registered! Please login.');
            showView('view-login');
        }

        function signupStudent() {
            const name = document.getElementById('sName').value;
            const pass = document.getElementById('sPass').value;
            const id = document.getElementById('sId').value;
            const no = document.getElementById('sNo').value;
            const batch = document.getElementById('sBatch').value;
            const cgpaStr = document.getElementById('sCgpa').value;
            const skillsStr = document.getElementById('sSkills').value;
            const linksStr = document.getElementById('sLinks').value;

            if(!name || !pass || !id) return showToast('Name, Password, and ID required');

            // ID Format Validation (XXX-XX-XXX)
            const idRegex = /^\d{3}-\d{2}-\d{3}$/;
            if (!idRegex.test(id)) {
                return showToast('Invalid ID format. Use: 242-15-479');
            }

            DB.students.push({
                name, password: pass, universityID: id, studentNo: no, batchNo: batch,
                cgpas: cgpaStr ? cgpaStr.split(',').map(n => parseFloat(n.trim())) : [],
                skills: skillsStr ? skillsStr.split(',').map(s => s.trim()) : [],
                links: linksStr ? linksStr.split(',').map(s => s.trim()) : [],
                submittedProblems: 0, problemsSolved: 0,
                evaluations: {} // Map course -> list of evals
            });
            DB.save();
            showToast('Student registered! Please login.');
            showView('view-login');
        }

        function login() {
            const name = document.getElementById('loginName').value;
            const pass = document.getElementById('loginPass').value;

            const teacher = DB.teachers.find(t => t.name === name && t.password === pass);
            if (teacher) {
                initSession(teacher, 'teacher');
                return;
            }

            const student = DB.students.find(s => s.name === name && s.password === pass);
            if (student) {
                initSession(student, 'student');
                return;
            }

            showToast('Invalid credentials');
        }

        function initSession(user, type) {
            currentUser = user;
            currentUserType = type;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('welcomeText').innerText = `Hello, ${user.name}`;
            
            if (type === 'teacher') {
                document.getElementById('teacherNameDisplay').innerText = user.name;
                document.getElementById('teacherInitialsDisplay').innerText = user.initials;
                document.getElementById('teacherCodeDisplay').innerText = user.courseCode;
                renderProfile();
                showView('view-teacher-dash');
                switchTab('t-profile');
            } else {
                document.getElementById('studentNameDisplay').innerText = user.name;
                document.getElementById('studentIdDisplay').innerText = user.universityID;
                renderProfile();
                showView('view-student-dash');
                switchTab('s-profile');
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            document.getElementById('userInfo').classList.add('hidden');
            showView('view-login');
        }

        // --- EDIT PROFILE ---
        function enableEditMode(type) {
            if(type === 'teacher') {
                document.getElementById('teacherProfileView').classList.add('hidden');
                document.getElementById('teacherProfileEdit').classList.remove('hidden');
                // Pre-fill
                document.getElementById('editTSubject').value = currentUser.subject;
                document.getElementById('editTContact').value = currentUser.contactNumber;
                document.getElementById('editTAvail').value = currentUser.availability;
            } else {
                document.getElementById('studentProfileView').classList.add('hidden');
                document.getElementById('studentProfileEdit').classList.remove('hidden');
                // Pre-fill
                document.getElementById('editSContact').value = currentUser.studentNo;
                document.getElementById('editSSkills').value = currentUser.skills.join(', ');
                document.getElementById('editSLinks').value = currentUser.links.join(', ');
            }
        }

        function cancelEdit(type) {
            if(type === 'teacher') {
                document.getElementById('teacherProfileView').classList.remove('hidden');
                document.getElementById('teacherProfileEdit').classList.add('hidden');
                document.getElementById('editTPass').value = '';
            } else {
                document.getElementById('studentProfileView').classList.remove('hidden');
                document.getElementById('studentProfileEdit').classList.add('hidden');
                document.getElementById('editSPass').value = '';
            }
        }

        function saveProfile(type) {
            let passInput = '';
            if(type === 'teacher') {
                currentUser.subject = document.getElementById('editTSubject').value;
                currentUser.contactNumber = document.getElementById('editTContact').value;
                currentUser.availability = document.getElementById('editTAvail').value;
                passInput = document.getElementById('editTPass').value;
            } else {
                currentUser.studentNo = document.getElementById('editSContact').value;
                currentUser.skills = document.getElementById('editSSkills').value.split(',').map(s => s.trim()).filter(s => s);
                currentUser.links = document.getElementById('editSLinks').value.split(',').map(s => s.trim()).filter(s => s);
                passInput = document.getElementById('editSPass').value;
            }

            if(passInput.trim()) {
                currentUser.password = passInput;
                showToast('Password Updated!');
            }

            DB.save();
            showToast('Profile Updated');
            cancelEdit(type);
            renderProfile();
        }

        // --- SEARCH FUNCTIONS ---
        function searchStudent() {
            const id = document.getElementById('searchStudentId').value.trim();
            const container = document.getElementById('student searchResult');
            
            if(!id) {
                container.innerHTML = '<p class="text-red-500 mt-2">Please enter an ID</p>';
                return;
            }

            const s = DB.students.find(st => st.universityID === id);
            if(!s) {
                container.innerHTML = '<p class="text-gray-500 mt-2">Student not found.</p>';
            } else {
                // Calculate Average and build comments list
                let totalStars = 0;
                let count = 0;
                let commentsHtml = '';

                // evaluations is a map: course -> array of objects
                for (const [course, evals] of Object.entries(s.evaluations)) {
                    evals.forEach(e => {
                        totalStars += e.stars;
                        count++;
                        const starsDisplay = '★'.repeat(e.stars) + '☆'.repeat(5 - e.stars);
                        commentsHtml += `
                            <div class="bg-white border p-2 rounded mb-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="font-bold text-indigo-700">${e.teacherName} <span class="text-xs text-gray-500">(${course})</span></span>
                                    <span class="text-yellow-500">${starsDisplay}</span>
                                </div>
                                <p class="text-gray-700 italic">"${e.comment}"</p>
                            </div>
                        `;
                    });
                }

                const average = count > 0 ? (totalStars / count).toFixed(1) : 'N/A';

                container.innerHTML = `
                    <div class="mt-4 border p-4 rounded bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${s.name}</h3>
                                <p class="text-sm text-gray-600">ID: ${s.universityID} | Batch: ${s.batchNo}</p>
                            </div>
                            <div class="text-center bg-white p-2 rounded border">
                                <span class="block text-2xl font-bold text-yellow-600">${average}</span>
                                <span class="text-xs text-gray-500">Avg Rating</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                            <p><strong>Contact:</strong> ${s.studentNo}</p>
                            <p><strong>Problems Solved:</strong> ${s.problemsSolved}</p>
                            <p><strong>CGPAs:</strong> ${s.cgpas.join(', ') || 'N/A'}</p>
                            <p><strong>Skills:</strong> ${s.skills.join(', ') || 'None'}</p>
                        </div>

                        <div class="mt-4 pt-4 border-t">
                            <h4 class="font-bold mb-2 text-gray-700">Teacher Evaluations</h4>
                            <div class="max-h-64 overflow-y-auto pr-1">
                                ${commentsHtml || '<p class="text-gray-400 italic">No evaluations yet.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function searchPeer() {
            const id = document.getElementById('searchPeerId').value.trim();
            const container = document.getElementById('peerSearchResult');
            
            if(!id) {
                container.innerHTML = '<p class="text-red-500 mt-2">Please enter an ID</p>';
                return;
            }

            const s = DB.students.find(st => st.universityID === id);
            if(!s) {
                container.innerHTML = '<p class="text-gray-500 mt-2">Student not found.</p>';
            } else {
                // Calculate Average
                let totalStars = 0;
                let count = 0;
                for (const [course, evals] of Object.entries(s.evaluations)) {
                    evals.forEach(e => {
                        totalStars += e.stars;
                        count++;
                    });
                }
                const average = count > 0 ? (totalStars / count).toFixed(1) : 'N/A';

                // Display simple info for peers (No detailed teacher comments for privacy/simplicity in this view)
                container.innerHTML = `
                    <div class="mt-4 border p-4 rounded bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${s.name}</h3>
                                <p class="text-sm text-gray-600">ID: ${s.universityID} | Batch: ${s.batchNo}</p>
                            </div>
                            <div class="text-center bg-white p-2 rounded border">
                                <span class="block text-2xl font-bold text-yellow-600">${average}</span>
                                <span class="text-xs text-gray-500">Avg Rating</span>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2 text-sm">
                             <p><strong>Skills:</strong> ${s.skills.join(', ') || 'None'}</p>
                             <p><strong>Problems Solved:</strong> ${s.problemsSolved}</p>
                             <p><strong>Links:</strong> ${s.links.join(', ') || 'None'}</p>
                        </div>
                    </div>
                `;
            }
        }

        function searchTeacher() {
            const nameQuery = document.getElementById('searchTeacherName').value.trim().toLowerCase();
            const container = document.getElementById('teacherSearchResult');
            
            if(!nameQuery) {
                container.innerHTML = '<p class="text-red-500 mt-2">Please enter a Name</p>';
                return;
            }

            const results = DB.teachers.filter(t => t.name.toLowerCase().includes(nameQuery));
            if(results.length === 0) {
                container.innerHTML = '<p class="text-gray-500 mt-2">No teacher found with that name.</p>';
            } else {
                let html = '<div class="space-y-3 mt-4">';
                results.forEach(t => {
                    html += `
                        <div class="border p-4 rounded bg-gray-50">
                            <h3 class="font-bold text-lg">${t.name}</h3>
                            <p><strong>Course:</strong> ${t.courseCode} (${t.subject})</p>
                            <p><strong>Contact:</strong> ${t.contactNumber}</p>
                            <p><strong>Availability:</strong> ${t.availability}</p>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        // --- TEACHER ACTIONS ---
        function submitEvaluation() {
            const id = document.getElementById('evalId').value;
            const course = document.getElementById('evalCourse').value;
            const stars = document.getElementById('evalStars').value;
            const comment = document.getElementById('evalComment').value;

            const student = DB.students.find(s => s.universityID === id);
            if (!student) return showToast('Student not found');

            if (!student.evaluations[course]) student.evaluations[course] = [];
            student.evaluations[course].push({
                stars: parseInt(stars),
                comment: comment,
                teacherName: currentUser.name
            });
            
            DB.save();
            showToast('Evaluation Submitted');
            // Clear form
            document.getElementById('evalId').value = '';
            document.getElementById('evalComment').value = '';
        }

        function addToExtraCare() {
            const id = document.getElementById('extraCareId').value;
            const student = DB.students.find(s => s.universityID === id);
            if (!student) return showToast('Student not found');
            
            if (DB.extraCare.find(s => s.universityID === id)) return showToast('Already in list');

            DB.extraCare.push(student);
            DB.save();
            renderExtraCareList();
            showToast('Added to Extra Care List');
        }

        function renderExtraCareList() {
            const container = document.getElementById('extraCareList');
            container.innerHTML = '';
            if (DB.extraCare.length === 0) container.innerHTML = '<p class="text-gray-400">List is empty</p>';
            
            DB.extraCare.forEach(s => {
                container.innerHTML += `
                    <div class="bg-pink-50 border border-pink-200 p-3 rounded flex justify-between items-center">
                        <div>
                            <p class="font-bold text-pink-800">${s.name}</p>
                            <p class="text-xs text-pink-600">ID: ${s.universityID} | Batch: ${s.batchNo}</p>
                        </div>
                        <span class="bg-pink-200 text-pink-800 text-xs px-2 py-1 rounded">Problem Solved: ${s.problemsSolved}</span>
                    </div>
                `;
            });
        }

        function renderLeaderboard(type) {
            const container = document.getElementById('leaderboardContent');
            let html = `<table class="w-full text-left text-sm"><thead><tr class="bg-gray-100 text-gray-600"><th class="p-2">Rank</th><th class="p-2">Name</th><th class="p-2">Info</th><th class="p-2">Solved</th></tr></thead><tbody>`;
            
            let list = [];
            if(type === 'student') {
                list = [...DB.students].sort((a,b) => b.problemsSolved - a.problemsSolved);
                list.forEach((s, i) => {
                    html += `<tr class="border-b"><td class="p-2 font-bold text-gray-500">#${i+1}</td><td class="p-2 font-medium">${s.name}</td><td class="p-2 text-gray-500">Batch: ${s.batchNo}</td><td class="p-2 font-bold text-indigo-600">${s.problemsSolved}</td></tr>`;
                });
            } else {
                list = [...DB.teachers].sort((a,b) => b.problemsSolved - a.problemsSolved);
                list.forEach((t, i) => {
                    html += `<tr class="border-b"><td class="p-2 font-bold text-gray-500">#${i+1}</td><td class="p-2 font-medium">${t.name}</td><td class="p-2 text-gray-500">${t.courseCode}</td><td class="p-2 font-bold text-indigo-600">${t.problemsSolved}</td></tr>`;
                });
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- STUDENT ACTIONS ---
        function submitProblem() {
            const course = document.getElementById('probCourse').value;
            const desc = document.getElementById('probDesc').value;
            
            if(!course || !desc) return showToast('All fields required');

            DB.problems.push({
                submitterName: currentUser.name,
                course: course,
                description: desc,
                solved: false,
                solution: "",
                proposedSolution: null,
                solverName: null,
                id: Date.now() // Simple unique ID
            });
            
            // FIXED BUG: Only increment once on the current user object
            // DB.save() will handle the persistence
            currentUser.submittedProblems++;
            
            DB.save();
            showToast('Problem Submitted');
            switchTab('s-problems');
            // Clear
            document.getElementById('probCourse').value = '';
            document.getElementById('probDesc').value = '';
        }

        function renderBatchLeaderboard() {
            const container = document.getElementById('studentBatchLeaderboard');
            const batch = currentUser.batchNo;
            const list = DB.students.filter(s => s.batchNo === batch).sort((a,b) => b.problemsSolved - a.problemsSolved);
            
            let html = `<p class="mb-2 text-sm text-gray-500">Batch: ${batch}</p><table class="w-full text-left"><thead><tr class="bg-green-50"><th class="p-2">Rank</th><th class="p-2">Name</th><th class="p-2">Solved</th></tr></thead><tbody>`;
            list.forEach((s, i) => {
                const isMe = s.name === currentUser.name ? 'bg-green-100' : '';
                html += `<tr class="border-b ${isMe}"><td class="p-2">#${i+1}</td><td class="p-2 font-medium">${s.name}</td><td class="p-2 font-bold">${s.problemsSolved}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- SHARED ACTIONS (PROBLEMS & PROFILE) ---
        function renderProfile() {
            const isTeacher = currentUserType === 'teacher';
            const container = isTeacher ? document.getElementById('teacherProfileView') : document.getElementById('studentProfileView');
            
            if (isTeacher) {
                container.innerHTML = `
                    <p><strong>Subject:</strong> ${currentUser.subject}</p>
                    <p><strong>Course Code:</strong> ${currentUser.courseCode}</p>
                    <p><strong>Contact:</strong> ${currentUser.contactNumber}</p>
                    <p><strong>Availability:</strong> ${currentUser.availability}</p>
                    <p><strong>Problems Solved:</strong> ${currentUser.problemsSolved}</p>
                `;
            } else {
                // Calculate Average for Profile
                let totalStars = 0;
                let count = 0;
                for (const [course, evals] of Object.entries(currentUser.evaluations)) {
                    evals.forEach(e => {
                        totalStars += e.stars;
                        count++;
                    });
                }
                const average = count > 0 ? (totalStars / count).toFixed(1) : 'N/A';

                container.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                             <p><strong>University ID:</strong> ${currentUser.universityID}</p>
                             <p><strong>Batch:</strong> ${currentUser.batchNo}</p>
                             <p><strong>Contact:</strong> ${currentUser.studentNo}</p>
                        </div>
                        <div class="text-center bg-yellow-50 p-2 rounded border border-yellow-200">
                             <span class="block text-xl font-bold text-yellow-600">${average} ★</span>
                             <span class="text-xs text-gray-500">Avg Rating</span>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1">
                        <p><strong>CGPA History:</strong> ${currentUser.cgpas.join(', ') || 'N/A'}</p>
                        <p><strong>Skills:</strong> ${currentUser.skills.join(', ') || 'None'}</p>
                        <p><strong>Links:</strong> ${currentUser.links.join(', ') || 'None'}</p>
                        <p class="mt-2 text-indigo-600 font-bold">Stats: Submitted ${currentUser.submittedProblems} | Solved ${currentUser.problemsSolved}</p>
                    </div>
                `;
                
                // Render evaluations
                const evalContainer = document.getElementById('studentEvaluationsList');
                evalContainer.innerHTML = '';
                const evals = currentUser.evaluations;
                if(Object.keys(evals).length === 0) {
                    evalContainer.innerHTML = '<p class="text-gray-400 italic">No evaluations yet.</p>';
                } else {
                    for(let course in evals) {
                        evals[course].forEach(e => {
                            const stars = '★'.repeat(e.stars) + '☆'.repeat(5-e.stars);
                            evalContainer.innerHTML += `
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-200 text-sm">
                                    <div class="flex justify-between font-bold text-yellow-800">
                                        <span>${course}</span>
                                        <span class="text-yellow-600">${stars}</span>
                                    </div>
                                    <p class="mt-1 text-gray-700">"${e.comment}"</p>
                                    <p class="text-xs text-right text-gray-500 mt-1">- ${e.teacherName}</p>
                                </div>
                            `;
                        });
                    }
                }
            }
        }

        function renderProblems(viewerType) {
            const container = viewerType === 'teacher' ? document.getElementById('teacherProblemList') : document.getElementById('studentProblemList');
            container.innerHTML = '';

            if (DB.problems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4">No problems submitted yet.</p>';
                return;
            }

            // Show newest first
            [...DB.problems].reverse().forEach(p => {
                let statusBadge = '';
                if(p.solved) statusBadge = `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Solved by ${p.solverName}</span>`;
                else if(p.proposedSolution) statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Solution Pending</span>`;
                else statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Open</span>`;

                const isMyProblem = p.submitterName === currentUser.name;
                
                // Action Buttons
                let actions = '';
                // If I am the submitter and there is a proposal but not solved
                if (isMyProblem && p.proposedSolution && !p.solved) {
                    actions = `
                        <div class="mt-3 bg-blue-50 p-3 rounded border border-blue-100">
                            <p class="text-sm font-bold text-blue-800">Proposed by ${p.solverName}:</p>
                            <p class="text-sm text-gray-700 italic my-1">"${p.proposedSolution}"</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="confirmSolution(${p.id})" class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">Accept & Confirm</button>
                                <button onclick="rejectSolution(${p.id})" class="bg-red-500 text-white text-xs px-3 py-1 rounded hover:bg-red-600">Reject</button>
                            </div>
                        </div>
                    `;
                }
                // If I am NOT the submitter and it's not solved, I can propose
                else if (!isMyProblem && !p.solved) {
                    // Check if I already proposed? (Logic simplified for this demo, usually user can overwrite their proposal)
                    actions = `
                        <div class="mt-3 flex gap-2">
                            <input type="text" id="sol-${p.id}" placeholder="Propose a solution..." class="flex-1 border p-1 rounded text-sm">
                            <button onclick="proposeSolution(${p.id})" class="bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-700">Send</button>
                        </div>
                    `;
                }
                // If solved, show solution
                else if (p.solved) {
                    actions = `
                        <div class="mt-3 bg-green-50 p-2 rounded border border-green-100">
                            <p class="text-xs font-bold text-green-800">Final Solution:</p>
                            <p class="text-sm text-gray-800">${p.solution}</p>
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div class="card bg-white p-5 rounded-lg shadow border-l-4 ${p.solved ? 'border-green-500' : 'border-gray-300'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-0.5 rounded uppercase tracking-wide">${p.course}</span>
                                <h3 class="text-md font-semibold mt-1">${p.description}</h3>
                                <p class="text-xs text-gray-500 mt-1">Submitted by ${p.submitterName}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        ${actions}
                    </div>
                `;
            });
        }

        function proposeSolution(id) {
            const p = DB.problems.find(prob => prob.id === id);
            const input = document.getElementById(`sol-${id}`);
            const text = input.value;
            
            if(!text.trim()) return showToast('Solution cannot be empty');
            
            p.proposedSolution = text;
            p.solverName = currentUser.name;
            DB.save();
            showToast('Solution Proposed!');
            renderProblems(currentUserType);
        }

        function confirmSolution(id) {
            const p = DB.problems.find(prob => prob.id === id);
            
            p.solution = p.proposedSolution;
            p.solved = true;
            
            // Credit the solver
            const solverTeacher = DB.teachers.find(t => t.name === p.solverName);
            if(solverTeacher) solverTeacher.problemsSolved++;
            
            const solverStudent = DB.students.find(s => s.name === p.solverName);
            if(solverStudent) solverStudent.problemsSolved++;
            
            DB.save();
            showToast('Solution Confirmed!');
            renderProblems(currentUserType);
        }

        function rejectSolution(id) {
            const p = DB.problems.find(prob => prob.id === id);
            p.proposedSolution = null;
            p.solverName = null;
            
            DB.save();
            showToast('Solution Rejected');
            renderProblems(currentUserType);
        }

        // --- UTILS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20');
            setTimeout(() => t.classList.add('translate-y-20'), 3000);
        }

        // Initial Load
        showView('view-login');

    </script>
</body>
</html>